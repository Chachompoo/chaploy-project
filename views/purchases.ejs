<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Purchases - Chaploy</title>
  <link rel="stylesheet" href="/stylesheets/homepage.css?v=<%= Date.now() %>">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <%- include('./partials/navbar') %>

  <div class="purchases-container">
    <h1>My Purchases</h1>

    <% if (orders.length === 0) { %>
      <p class="empty">You have no orders yet.</p>
    <% } else { %>
      <table class="purchases-table">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Date</th>
            <th>Total</th>
            <th>Payment</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
        <% orders.forEach(order => { %>
        <tr>
            <td><%= order.order_id.toString().padStart(4, '0') %></td>
            <td><%= order.order_date %></td>
            <td>$<%= order.total.toLocaleString('en-US', { minimumFractionDigits: 2 }) %></td>
            <td>
              <% if (order.payment_status === 'paid') { %>
                <span class="badge paid">Paid</span>
              <% } else { %>
                <span class="badge pending">Pending</span>
              <% } %>
            </td>
            <td>
              <% if (order.order_status === 'pending') { %>
                <span class="badge pending">Pending</span>
              <% } else if (order.order_status === 'confirmed') { %>
                <span class="badge confirmed">Confirmed</span>
              <% } else if (order.order_status === 'shipped') { %>
                <span class="badge shipped">Shipped</span>
              <% } else if (order.order_status === 'delivered') { %>
                <span class="badge delivered">Delivered</span>
              <% } else if (order.order_status === 'cancelled') { %>
                <span class="badge cancelled">Cancelled</span>
              <% } %>
            </td>
            <td class="actions">
              <button class="btn-view" onclick="viewOrder(<%= order.order_id %>)">View</button>
              <% if (order.order_status.toLowerCase() === 'pending') { %>
                <button class="btn-cancel" onclick="cancelOrder(<%= order.order_id %>)">Cancel</button>
              <% } else { %>
                <button class="btn-disabled" onclick="cannotCancel()">Cancel</button>
              <% } %>
            </td>
        </tr>
        <% }); %>
        </tbody>
      </table>
    <% } %>
  </div>

<script>
async function viewOrder(orderId) {
  try {
    const res = await fetch(`/purchases/items/${orderId}`);
    const data = await res.json();
    if (!data.success) {
      return Swal.fire({
        icon: 'info',
        title: 'No items found',
        text: data.message || 'This order does not contain any products.',
        confirmButtonColor: '#43593E'
      });
    }

    let total = 0;
    const html = `
      <div style="max-height:400px;overflow-y:auto;text-align:left;">
        ${data.items.map(it => {
          const line = (it.subtotal != null ? parseFloat(it.subtotal) : (parseFloat(it.unit_price) * parseInt(it.quantity,10))) || 0;
          total += line;
          return `
            <div style="display:flex;align-items:center;margin-bottom:10px;">
              <img src="${it.image}" alt="${it.name}"
                   style="width:60px;height:60px;border-radius:10px;margin-right:10px;object-fit:cover;">
              <div>
                <strong>${it.name}</strong><br>
                Quantity: ${it.quantity}<br>
                Price: $${line.toFixed(2)}
              </div>
            </div>
          `;
        }).join('')}
        <hr style="margin:10px 0;">
        <div style="text-align:right;font-weight:700;">Total: $${total.toFixed(2)}</div>
      </div>
    `;

    Swal.fire({
      title: 'Order Details',
      html,
      width: 600,
      confirmButtonText: 'OK',
      confirmButtonColor: '#43593E'
    });
  } catch (e) {
    Swal.fire({
      icon: 'error',
      title: 'Server Error',
      text: 'Failed to load order details.',
      confirmButtonColor: '#43593E'
    });
  }
}

// ==============================
// ‚úÖ Cancel Order 
// ==============================
async function cancelOrder(orderId) {
  const result = await Swal.fire({
    title: 'Cancel this order?',
    text: 'Are you sure you want to cancel this order?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#43593E',
    cancelButtonColor: '#888',
    confirmButtonText: 'Yes, cancel it'
  });

  if (!result.isConfirmed) return;

  try {
    const res = await fetch(`/purchases/cancel/${orderId}`, { method: 'POST' });

    // üîç Step 1: ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å server ‡πÅ‡∏ö‡∏ö raw ‡∏Å‡πà‡∏≠‡∏ô
    const text = await res.text();
    console.log('üì¶ Raw response from server:', text);

    // üîç Step 2: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse JSON
    let data;
    try {
      data = JSON.parse(text);
    } catch (err) {
      console.warn('‚ö†Ô∏è Response is not valid JSON. Using fallback mode.');
      data = { success: res.ok, message: text };
    }

    // ‚úÖ Step 3: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≤‡∏° response ‡∏à‡∏£‡∏¥‡∏á
    if (res.status === 403) {
      return Swal.fire({
        icon: 'info',
        title: 'Please Login',
        text: 'You must be logged in to cancel your order.',
        confirmButtonColor: '#43593E'
      });
    }

    if (res.status === 404) {
      return Swal.fire({
        icon: 'warning',
        title: 'Order Not Found',
        text: data.message || 'This order could not be found.',
        confirmButtonColor: '#43593E'
      });
    }

    if (res.status === 400) {
      return Swal.fire({
        icon: 'error',
        title: 'Cannot Cancel',
        text: data.message || 'This order cannot be cancelled.',
        confirmButtonColor: '#43593E'
      });
    }

    if (res.ok && data.success) {
      await Swal.fire({
        icon: 'success',
        title: 'Order Cancelled',
        text: 'Your order has been cancelled successfully.',
        confirmButtonColor: '#43593E'
      });
      return window.location.reload();
    }

    // üî¥ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÑ‡∏´‡∏ô‡πÄ‡∏•‡∏¢
    Swal.fire({
      icon: 'error',
      title: 'Unexpected Error',
      text: data.message || 'Something went wrong while cancelling the order.',
      confirmButtonColor: '#43593E'
    });

  } catch (err) {
    console.error('‚ùå Fetch error:', err);
    Swal.fire({
      icon: 'error',
      title: 'Server Error',
      text: 'The server did not respond correctly. Please try again later.',
      confirmButtonColor: '#43593E'
    });
  }
}

</script>
</body>
</html>
