<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | Chaploy</title>
  <link rel="stylesheet" href="/stylesheets/navbar.css">
  <link rel="stylesheet" href="/stylesheets/basket.css">

  <!-- âœ… à¹ƒà¸ªà¹ˆ SweetAlert2 à¹„à¸§à¹‰à¹ƒà¸™ <head> -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <%- include('../partials/navbar') %>

  <div class="basket-container">
    <h1>Your Basket</h1>

    <% if (products.length === 0) { %>
      <p class="empty">Your basket is currently empty.</p>
    <% } else { %>
      <div class="basket-list">
        <% products.forEach(p => { %>
          <div class="basket-item" data-id="<%= p.id %>">
            <img src="<%= p.image %>" alt="<%= p.name %>">
            
            <div class="info">
              <h3><%= p.name %></h3>
              <p class="price">$<%= Number(p.price).toFixed(2) %></p>
              <!-- âœ… à¹€à¸žà¸´à¹ˆà¸¡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ªà¸”à¸‡ stock -->
              <p class="stock-text">In stock: <%= p.stock %></p>
            </div>

            <!-- âœ… à¸›à¸¸à¹ˆà¸¡ - / + -->
            <div class="qty-controls">
              <button class="qty-btn minus" data-id="<%= p.id %>">-</button>
              <span class="qty-value"><%= p.qty %></span>
              <button class="qty-btn plus" data-id="<%= p.id %>">+</button>
            </div>
          </div>
        <% }) %>
      </div>

      <div class="basket-summary">
        <h2>Total: $<%= total.toFixed(2) %></h2>
        <a class="btn-checkout" href="/shop/checkout">PROCEED TO CHECKOUT</a>
      </div>
    <% } %>
  </div>

  <script>
document.querySelectorAll(".qty-btn").forEach(btn => {
  btn.addEventListener("click", async (e) => {
    const id = e.target.dataset.id;
    const action = e.target.classList.contains("plus") ? "plus" : "minus";
    console.log("ðŸŸ¢ Click:", id, action); // <--- à¹€à¸žà¸´à¹ˆà¸¡ log à¹„à¸§à¹‰à¹€à¸Šà¹‡à¸

    try {
      const res = await fetch("/shop/cart/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productId: id, action })
      });

      console.log("ðŸŸ¡ Response status:", res.status); // à¹€à¸žà¸´à¹ˆà¸¡ log

      const resData = await res.json();
      console.log("ðŸŸ¢ Response data:", resData);

      if (resData.success) {
        location.reload();
      } else {
        Swal.fire({
          icon: resData.message === "Out of stock" ? "warning" : "error",
          title: resData.message === "Out of stock" ? "à¸ªà¸´à¸™à¸„à¹‰à¸²à¸«à¸¡à¸”à¸ªà¸•à¹‡à¸­à¸!" : "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”",
          text: resData.message || "à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡à¸„à¹ˆà¸°",
          confirmButtonColor: "#000"
        });
      }
    } catch (err) {
      console.error("âŒ Fetch error:", err);
      Swal.fire({
        icon: "error",
        title: "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”",
        text: "à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸•à¸´à¸”à¸•à¹ˆà¸­à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¹„à¸”à¹‰à¸„à¹ˆà¸°",
        confirmButtonColor: "#000"
      });
    }
  });
});
</script>

</body>
</html>
